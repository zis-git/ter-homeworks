# Домашнее задание к занятию «Управляющие конструкции в коде Terraform» Голоха Е.В.

### Цели задания

### Задание 1

1. Изучите проект.
2. Инициализируйте проект, выполните код. 


Приложите скриншот входящих правил «Группы безопасности» в ЛК Yandex Cloud .

### Решение 1

Создана VPC-сеть develop, подсеть develop в зоне ru-central1-a и группа безопасности example_dynamic с динамическими правилами ingress/egress.
Настроен провайдер Yandex Cloud через сервисный аккаунт (authorized_key.json).

Инициализация Terraform:

<img width="677" height="452" alt="Снимок экрана 2025-10-29 в 09 15 04" src="https://github.com/user-attachments/assets/ff951802-1ddc-459f-9034-f1858cce673a" />

Проверка конфигурации:
<img width="465" height="59" alt="Снимок экрана 2025-10-29 в 09 19 44" src="https://github.com/user-attachments/assets/f85a42ee-c49d-4fa7-b511-e64176ce2149" />

Создание сети и подсети:
<img width="542" height="116" alt="Снимок экрана 2025-10-29 в 09 13 42" src="https://github.com/user-attachments/assets/2d89510a-934d-4d55-a5c8-65cf203304e6" />

<img width="913" height="466" alt="Снимок экрана 2025-10-29 в 09 28 33" src="https://github.com/user-attachments/assets/d5dffa13-b303-46a1-9195-65ebd1c3d335" />

Проверка ресурсов через yc CLI:

yc vpc network list

yc vpc subnet list

<img width="684" height="504" alt="Снимок экрана 2025-10-29 в 09 07 19" src="https://github.com/user-attachments/assets/aa21460e-6ca7-4973-9b64-36fa3e3e0c03" />

Результат:
Сеть и подсеть успешно созданы, группа безопасности активна и разрешает входящие SSH (22), HTTP (80), HTTPS (443).


### Задание 2

1. Создайте файл count-vm.tf. Опишите в нём создание двух **одинаковых** ВМ  web-1 и web-2 (не web-0 и web-1) с минимальными параметрами, используя мета-аргумент **count loop**. Назначьте ВМ созданную в первом задании группу безопасности.(как это сделать узнайте в документации провайдера yandex/compute_instance )
2. Создайте файл for_each-vm.tf. Опишите в нём создание двух ВМ для баз данных с именами "main" и "replica" **разных** по cpu/ram/disk_volume , используя мета-аргумент **for_each loop**. Используйте для обеих ВМ одну общую переменную типа:
```
variable "each_vm" {
  type = list(object({  vm_name=string, cpu=number, ram=number, disk_volume=number }))
}
```  
При желании внесите в переменную все возможные параметры.
4. ВМ из пункта 2.1 должны создаваться после создания ВМ из пункта 2.2.
5. Используйте функцию file в local-переменной для считывания ключа ~/.ssh/id_rsa.pub и его последующего использования в блоке metadata, взятому из ДЗ 2.
6. Инициализируйте проект, выполните код.

------
### Решение 2

count — создание двух web-серверов
count-vm.tf

<img width="657" height="111" alt="Снимок экрана 2025-10-29 в 09 40 06" src="https://github.com/user-attachments/assets/046af671-fb15-4cd0-9caa-3b66d807895d" />

Параметры:

count = 2

name = "web-${count.index + 1}"

cores = 2, memory = 2, core_fraction = 20

boot_disk.size = 10

preemptible = true

Проверка валидности:

<img width="604" height="340" alt="Снимок экрана 2025-10-29 в 09 41 54" src="https://github.com/user-attachments/assets/2d550901-46bc-41d6-a9de-a57cef66c744" />

Применение:

<img width="668" height="48" alt="Снимок экрана 2025-10-29 в 09 48 05" src="https://github.com/user-attachments/assets/a0ce7d69-000f-4dea-bffa-7be8b351e8e9" />


for_each — создание двух БД main и replica

Код:

Файл for_each-vm.tf использует переменную each_vm из variables.tf.

<img width="666" height="341" alt="Снимок экрана 2025-10-29 в 09 49 55" src="https://github.com/user-attachments/assets/8630b77c-4e68-4ddd-9d8f-8de7503f3df6" />

Проверка : 
<img width="674" height="54" alt="Снимок экрана 2025-10-29 в 09 53 39" src="https://github.com/user-attachments/assets/8b30808e-22bd-4dbc-aaa7-34efc7d79ab4" />



### Задание 3

1. Создайте 3 одинаковых виртуальных диска размером 1 Гб с помощью ресурса yandex_compute_disk и мета-аргумента count в файле **disk_vm.tf** .
2. Создайте в том же файле **одиночную**(использовать count или for_each запрещено из-за задания №4) ВМ c именем "storage"  . Используйте блок **dynamic secondary_disk{..}** и мета-аргумент for_each для подключения созданных вами дополнительных дисков.

------
### Решение 3
Код:
Файл disk_vm.tf
Создаётся три диска (count = 3) и одна ВМ storage, подключающая их через dynamic "secondary_disk".

Применение:
<img width="660" height="387" alt="Снимок экрана 2025-10-29 в 09 57 56" src="https://github.com/user-attachments/assets/661b6525-d1e5-4e34-8903-38f92f043123" />

ВМ storage успешно создана, к ней подключено 3 дополнительных диска по 1 ГБ каждый.

### Задание 4

1. В файле ansible.tf создайте inventory-файл для ansible.
Используйте функцию tepmplatefile и файл-шаблон для создания ansible inventory-файла из лекции.
Готовый код возьмите из демонстрации к лекции [**demonstration2**](https://github.com/netology-code/ter-homeworks/tree/main/03/demo).
Передайте в него в качестве переменных группы виртуальных машин из задания 2.1, 2.2 и 3.2, т. е. 5 ВМ.
2. Инвентарь должен содержать 3 группы и быть динамическим, т. е. обработать как группу из 2-х ВМ, так и 999 ВМ.
3. Добавьте в инвентарь переменную  [**fqdn**](https://cloud.yandex.ru/docs/compute/concepts/network#hostname).
``` 
[webservers]
web-1 ansible_host=<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>
web-2 ansible_host=<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>

[databases]
main ansible_host=<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>
replica ansible_host<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>

[storage]
storage ansible_host=<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>
```
Пример fqdn: ```web1.ru-central1.internal```(в случае указания переменной hostname(не путать с переменной name)); ```fhm8k1oojmm5lie8i22a.auto.internal```(в случае отсутвия перменной hostname - автоматическая генерация имени,  зона изменяется на auto). нужную вам переменную найдите в документации провайдера или terraform console.
4. Выполните код. Приложите скриншот получившегося файла. 

Для общего зачёта создайте в вашем GitHub-репозитории новую ветку terraform-03. Закоммитьте в эту ветку свой финальный код проекта, пришлите ссылку на коммит.   
**Удалите все созданные ресурсы**.

------
### Решение 4
Создан шаблон ansible.tftpl и файл ansible.tf, в котором используется templatefile() для генерации ansible_inventory.ini.

Инициализация:

<img width="676" height="523" alt="Снимок экрана 2025-10-29 в 10 02 24" src="https://github.com/user-attachments/assets/4fee0918-2a0b-4330-8e77-d22278146757" />

Применение шаблона:
<img width="676" height="480" alt="Снимок экрана 2025-10-29 в 10 09 24" src="https://github.com/user-attachments/assets/cc6655e5-60db-494a-af14-3cc301a24de6" />

Содержимое итогового файла:
<img width="686" height="186" alt="Снимок экрана 2025-10-29 в 10 11 10" src="https://github.com/user-attachments/assets/aa377374-9e60-4982-987e-819f9dff7f3d" />


""
[webservers]
web-1 ansible_host=158.160.122.203 fqdn=fhm05ejes0bilmjt6b5m.auto.internal
web-2 ansible_host=158.160.115.46 fqdn=fhmrhbr6d9ppdmlboko3.auto.internal

[databases]
db-main ansible_host=158.160.120.129 fqdn=fhmhg8bjuc4ff8vkcllt9.auto.internal
db-replica ansible_host=158.160.97.63 fqdn=fhmtt62un56dmtsjafgd.auto.internal

[storage]
storage ansible_host=62.84.126.89 fqdn=fhmr3b39l4mhhvvfdk8c.auto.internal
""

Уничтожение инфраструктуры
Первое удаление (основные ресурсы):
<img width="676" height="204" alt="Снимок экрана 2025-10-29 в 10 29 41" src="https://github.com/user-attachments/assets/0e4b91f7-f651-4662-b967-44ae1dca55ef" />

Повторное выполнение (проверка):
<img width="668" height="254" alt="Снимок экрана 2025-10-29 в 10 33 19" src="https://github.com/user-attachments/assets/4f89665c-f653-4ebb-9630-f511a1b5d969" />
